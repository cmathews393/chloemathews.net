name: Generate resume PDF

on:
    push:
        branches: [main]
        # avoid re-running this workflow when the generated PDF is the only change
        paths-ignore:
            - "public/resume.pdf"
    workflow_dispatch: {}

concurrency:
    group: generate-resume
    cancel-in-progress: true

permissions:
    contents: write

jobs:
    generate:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  persist-credentials: true

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Install LaTeX dependencies
              run: |
                  sudo apt-get update
                  # install a minimal texlive set that includes pdflatex + common packages used in the resume template
                  sudo apt-get install -y texlive-latex-base texlive-latex-recommended texlive-latex-extra texlive-fonts-recommended

            - name: Install npm dependencies
              run: |
                  # prefer a fast, reproducible install; fall back to npm install when package-lock is absent
                  npm ci --prefer-offline --no-audit || npm install --no-audit

            - name: Generate PDF
              id: generate_resume
              run: |
                  npm run generate:resume
                  if [ -f public/resume.pdf ]; then echo "pdf_exists=true" >> $GITHUB_OUTPUT; else echo "pdf_exists=false" >> $GITHUB_OUTPUT; fi

            - name: Show output (for debugging)
              run: |
                  if [ -f public/resume.pdf ]; then ls -l public/resume.pdf; else echo "resume.pdf not generated"; fi

            - name: Upload resume.pdf as workflow artifact
              if: steps.generate_resume.outputs.pdf_exists == 'true'
              uses: actions/upload-artifact@v4
              with:
                  name: resume.pdf
                  path: public/resume.pdf

            - name: Create release
              id: create_release
              if: steps.generate_resume.outputs.pdf_exists == 'true'
              uses: actions/create-release@v1
              with:
                  tag_name: resume-${{ github.run_number }}
                  release_name: Resume PDF ${{ github.run_number }}
                  body: "Automated resume build from workflow #${{ github.run_id }}"
                  draft: false
                  prerelease: false

            - name: Upload resume.pdf to release
              if: steps.generate_resume.outputs.pdf_exists == 'true' && steps.create_release.outputs.upload_url != ''
              uses: actions/upload-release-asset@v1
              with:
                  upload_url: ${{ steps.create_release.outputs.upload_url }}
                  asset_path: public/resume.pdf
                  asset_name: resume.pdf
                  asset_content_type: application/pdf
